// Prisma Schema for L&T IPMS Conversational App
// This schema defines models for storing conversation history

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
  output               = "../.venv/Lib/site-packages/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Conversation model - represents a chat thread
model Conversation {
  id        String    @id @default(uuid())
  threadId  String    @unique @map("thread_id")
  title     String?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  messages  Message[]

  @@map("conversations")
}

// Message model - individual messages in a conversation
model Message {
  id             String       @id @default(uuid())
  conversationId String       @map("conversation_id")
  role           String       // 'user', 'assistant', 'system', 'tool'
  content        String
  // Token tracking
  inputTokens    Int?         @map("input_tokens")
  outputTokens   Int?         @map("output_tokens")
  totalTokens    Int?         @map("total_tokens")
  // Tool call tracking
  toolCalls      Json?        @map("tool_calls")    // Array of {name, args, result}
  toolName       String?      @map("tool_name")     // For tool result messages
  // Model info
  model          String?      // Model used for this response
  // Feedback tracking
  feedback       String?      // 'positive', 'negative', or null
  feedbackNote   String?      @map("feedback_note")  // Optional user comment
  editedFrom     String?      @map("edited_from")    // ID of original message if this is an edit
  // Branching/versioning fields for ChatGPT-style navigation
  positionIndex  Int?         @map("position_index")   // Logical position in conversation (0, 1, 2...)
  branchIndex    Int          @default(0) @map("branch_index")  // Version at this position (0 = original, 1 = first edit)
  activeBranch   Boolean      @default(true) @map("active_branch")  // Is this the currently visible version?
  // Flexible metadata JSON for additional info
  metadata       Json?        // {latency_ms, finish_reason, etc.}
  createdAt      DateTime     @default(now()) @map("created_at")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([role])
  @@index([conversationId, positionIndex, activeBranch])
  @@map("messages")
}



// User model - stores user credentials and profile
model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  passwordHash  String    @map("password_hash")
  systemRole    String    @default("USER") @map("system_role")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  sessions      Session[]
  
  @@map("users")
}

// Session model - stores active user sessions
model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("sessions")
}



// tbl_01_Project_summary - Project-level summary metrics
model Tbl01ProjectSummary {
  id                           Int      @id @default(autoincrement())
  project_id                   String   @map("project_id")
  projectKey                   Int      @map("project_key")
  startDate                    DateTime @map("start_date")
  endDate                      DateTime @map("end_date")
  projectDescription           String   @map("project_description")
  projectLocation              String   @map("project_location")
  pei                          Float
  spi                          Float
  forecastDelayDays            Int      @map("forecast_delay_days")
  computedDays                 Int      @map("computed_days")
  extensionExposureDays        Int      @map("extension_exposure_days")
  workfrontPercentage          Float    @map("workfront_percentage")
  readyTask                    Int      @map("ready_task")
  workfrontTotalTasks          Int      @map("workfront_total_tasks")
  criticalPercentage           Float    @map("critical_percentage")
  criticalYesCount             Int      @map("critical_yes_count")
  criticalNoCount              Int      @map("critical_no_count")
  criticalTotalTasks           Int      @map("critical_total_tasks")
  executedQuantity             Float    @map("executed_quantity")
  totalAvailableQuantity       Float    @map("total_available_quantity")
  executableProgressPercent    Float    @map("executable_progress_percent")
  tasksPlannedInLookAhead      Int      @map("tasks_planned_in_lookahead")
  tasksCompletedLookAhead      Int      @map("tasks_completed_lookahead")
  lookAheadCompliancePercent   Float    @map("look_ahead_compliance_percent")
  createdAt                    DateTime @default(now()) @map("created_at")

  @@index([project_id])
  @@index([projectKey])
  @@map("tbl_01_Project_summary")
}

// tbl_02_ProjectActivity - Project activity-level data
model Tbl02ProjectActivity {
  id                           Int       @id @default(autoincrement())
  projectKey                   Int       @map("project_key")
  activityCode                 String    @map("activity_code")
  activityDescription          String    @map("activity_description")
  workfrontPct                 Float     @map("workfront_pct")
  readyTasks                   Int       @map("ready_tasks")
  totalTasks                   Int       @map("total_tasks")
  criticalPercentage           Float     @map("critical_percentage")
  tasksPlannedInLookAhead      Int       @map("tasks_planned_in_lookahead")
  tasksCompleted               Int       @map("tasks_completed")
  lookAheadCompliancePercent   Float     @map("look_ahead_compliance_percent")
  delayDays                    Int       @map("delay_days")
  computedDelay                Int       @map("computed_delay")
  taskActualStartDate          DateTime? @map("task_actual_start_date")
  taskActualFinishDate         DateTime? @map("task_actual_finish_date")
  taskForecastStartDate        DateTime? @map("task_forecast_start_date")
  taskForecastFinishDate       DateTime? @map("task_forecast_finish_date")
  taskPlanStartDate            DateTime? @map("task_plan_start_date")
  taskPlanFinishDate           DateTime? @map("task_plan_finish_date")
  taskKey                      String    @map("task_key")
  createdAt                    DateTime  @default(now()) @map("created_at")

  @@index([projectKey])
  @@index([activityCode])
  @@map("tbl_02_ProjectActivity")
}
