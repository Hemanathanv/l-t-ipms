// Prisma Schema for L&T IPMS Conversational App
// This schema defines models for storing conversation history

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
  output               = "../.venv/Lib/site-packages/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Conversation model - represents a chat thread
model Conversation {
  id        String    @id @default(uuid())
  threadId  String    @unique @map("thread_id")
  title     String?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  messages  Message[]

  @@map("conversations")
}

// Message model - individual messages in a conversation
model Message {
  id             String       @id @default(uuid())
  conversationId String       @map("conversation_id")
  role           String       // 'user', 'assistant', 'system', 'tool'
  content        String
  // Token tracking
  inputTokens    Int?         @map("input_tokens")
  outputTokens   Int?         @map("output_tokens")
  totalTokens    Int?         @map("total_tokens")
  // Tool call tracking
  toolCalls      Json?        @map("tool_calls")    // Array of {name, args, result}
  toolName       String?      @map("tool_name")     // For tool result messages
  // Model info
  model          String?      // Model used for this response
  // Flexible metadata JSON for additional info
  metadata       Json?        // {latency_ms, finish_reason, etc.}
  createdAt      DateTime     @default(now()) @map("created_at")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([role])
  @@map("messages")
}

// SRA Dataset - Project performance metrics
model SraTable {
  id                          Int      @id @default(autoincrement())
  projectId                   String   @map("project_id")
  date                        DateTime
  projectName                 String   @map("project_name")
  plannedFinishDate           DateTime @map("planned_finish_date")
  forecastFinishDate          DateTime @map("forecast_finish_date")
  plannedValueAmount          Float    @map("planned_value_amount")
  earnedValueAmount           Float    @map("earned_value_amount")
  actualCostAmount            Float    @map("actual_cost_amount")
  spiValue                    Float    @map("spi_value")
  cpiValue                    Float    @map("cpi_value")
  billingReadinessPct         Float    @map("billing_readiness_pct")
  peiValue                    Float    @map("pei_value")
  totalScopeQty               Float    @map("total_scope_qty")
  rowAvailableQty             Float    @map("row_available_qty")
  executedQty                 Float    @map("executed_qty")
  executableProgressPct       Float    @map("executable_progress_pct")
  remainingScopeQty           Float    @map("remaining_scope_qty")
  requiredRateQty             Float    @map("required_rate_qty")
  maxAchievedRateQty          Float    @map("max_achieved_rate_qty")
  requiredRateFeasibilityPct  Float    @map("required_rate_feasibility_pct")
  criticalDelayDays           Int      @map("critical_delay_days")
  topDelayOwnerCategory       String?  @map("top_delay_owner_category")
  lookaheadPlannedCountWeek   Int      @map("lookahead_planned_count_week")
  lookaheadCompletedCountWeek Int      @map("lookahead_completed_count_week")
  lookaheadCompliancePct      Float    @map("lookahead_compliance_pct")
  criticalDensityPct          Float    @map("critical_density_pct")
  createdAt                   DateTime @default(now()) @map("created_at")

  @@index([projectId])
  @@index([date])
  @@map("sratable")
}

// User model - stores user credentials and profile
model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  passwordHash  String    @map("password_hash")
  systemRole    String    @default("USER") @map("system_role")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  sessions      Session[]
  
  @@map("users")
}

// Session model - stores active user sessions
model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// SRA Activity-Level Dataset - Activity performance metrics with PEI
model SraActivityTable {
  id                       Int      @id @default(autoincrement())
  date                     DateTime
  projectId                String   @map("project_id")
  projectName              String   @map("project_name")
  activityId               String   @map("activity_id")
  activityName             String   @map("activity_name")
  isCriticalFlag           Int      @map("is_critical_flag")
  plannedFinishDate        DateTime @map("planned_finish_date")
  forecastFinishDate       DateTime @map("forecast_finish_date")
  plannedStartDate         DateTime @map("planned_start_date")
  plannedFinishActivityDate DateTime @map("planned_finish_activity_date")
  plannedValueAmount       Float    @map("planned_value_amount")
  earnedValueAmount        Float    @map("earned_value_amount")
  totalScopeQty            Float    @map("total_scope_qty")
  rowAvailableQty          Float    @map("row_available_qty")
  executedQty              Float    @map("executed_qty")
  totalFloatDays           Float    @map("total_float_days")
  cpiValue                 Float    @map("cpi_value")
  billingReadinessPct      Float    @map("billing_readiness_pct")
  riskProfile              Float    @map("risk_profile")
  spiValue                 Float    @map("spi_value")
  peiValue                 Float    @map("pei_value")
  forecastDelayDays        Int      @map("forecast_delay_days")
  workfrontReadinessPct    Float    @map("workfront_readiness_pct")
  avgFloat                 Float    @map("avg_float")
  createdAt                DateTime @default(now()) @map("created_at")

  @@index([projectId])
  @@index([activityId])
  @@index([date])
  @@map("sra_activity_table")
}
