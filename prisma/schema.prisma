// Prisma Schema for L&T IPMS Conversational App
// This schema defines models for storing conversation history

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
  output               = "../.venv/Lib/site-packages/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Conversation model - represents a chat thread
model Conversation {
  id        String    @id @default(uuid())
  threadId  String    @unique @map("thread_id")
  title     String?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  messages  Message[]

  @@map("conversations")
}

// Message model - individual messages in a conversation
model Message {
  id             String       @id @default(uuid())
  conversationId String       @map("conversation_id")
  role           String       // 'user', 'assistant', 'system', 'tool'
  content        String
  // Token tracking
  inputTokens    Int?         @map("input_tokens")
  outputTokens   Int?         @map("output_tokens")
  totalTokens    Int?         @map("total_tokens")
  // Tool call tracking
  toolCalls      Json?        @map("tool_calls")    // Array of {name, args, result}
  toolName       String?      @map("tool_name")     // For tool result messages
  // Model info
  model          String?      // Model used for this response
  // Feedback tracking
  feedback       String?      // 'positive', 'negative', or null
  feedbackNote   String?      @map("feedback_note")  // Optional user comment
  editedFrom     String?      @map("edited_from")    // ID of original message if this is an edit
  // Branching/versioning fields for ChatGPT-style navigation
  positionIndex  Int?         @map("position_index")   // Logical position in conversation (0, 1, 2...)
  branchIndex    Int          @default(0) @map("branch_index")  // Version at this position (0 = original, 1 = first edit)
  activeBranch   Boolean      @default(true) @map("active_branch")  // Is this the currently visible version?
  // Flexible metadata JSON for additional info
  metadata       Json?        // {latency_ms, finish_reason, etc.}
  createdAt      DateTime     @default(now()) @map("created_at")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([role])
  @@index([conversationId, positionIndex, activeBranch])
  @@map("messages")
}



// User model - stores user credentials and profile
model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  passwordHash  String    @map("password_hash")
  systemRole    String    @default("USER") @map("system_role")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  sessions      Session[]
  
  @@map("users")
}

// Session model - stores active user sessions
model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("sessions")
}



model Tbl01ProjectSummary {
 
  id   Int @id @default(autoincrement())
 
 
  projectKey         Int    @map("project_key")
  projectId          String @map("project_id")
  projectDescription String @map("project_description")
  projectLocation    String @map("project_location")
 
  baselineStartDate         DateTime  @map("baseline_start_date")
  baselineFinishDate        DateTime  @map("baseline_finish_date")
  forecastStartDate         DateTime? @map("forecast_start_date")
  forecastFinishDate        DateTime? @map("forecast_finish_date")
  actualStartDate           DateTime? @map("actual_start_date")       // NEW-2
  contractualEndDate        DateTime  @map("contractual_end_date")
 
  baselineDurationDays      Int       @map("baseline_duration_days")
  forecastDurationDays      Int       @map("forecast_duration_days")
  adjustedTotalDurationDays Int       @map("adjusted_total_duration_days") // forecast_finish - baseline_start
 
  slipDays               Int @map("slip_days")                   // +ve = slipped  |  -ve = early
  scheduleVarianceDays   Int @map("schedule_variance_days")      // inverse of slip_days
 
  projectExecutionIndex  Float @map("project_execution_index")   // PEI = forecast_duration / baseline_duration
 
  eotExposureDays Int @map("eot_exposure_days")                  // Max WBS delay on S Curve 1
 
  
  // SPI (S Curve actual / planned cumulative ratio)
  spiOverall       Float @map("spi_overall")
  spiEngineering   Float @map("spi_engineering")
  spiProcurement   Float @map("spi_procurement")
  spiConstruction  Float @map("spi_construction")
 
  
  cumulativePlannedOverall  Float @map("cumulative_planned_overall")
  cumulativeActualOverall   Float @map("cumulative_actual_overall")
  cumulativeBacklogOverall  Float @map("cumulative_backlog_overall")
 
  
  cumulativePlannedEngineering  Float @map("cumulative_planned_engineering")
  cumulativeActualEngineering   Float @map("cumulative_actual_engineering")
  cumulativeBacklogEngineering  Float @map("cumulative_backlog_engineering")
 
  
  cumulativePlannedProcurement  Float @map("cumulative_planned_procurement")
  cumulativeActualProcurement   Float @map("cumulative_actual_procurement")
  cumulativeBacklogProcurement  Float @map("cumulative_backlog_procurement")
 
  
  cumulativePlannedConstruction  Float @map("cumulative_planned_construction")
  cumulativeActualConstruction   Float @map("cumulative_actual_construction")
  cumulativeBacklogConstruction  Float @map("cumulative_backlog_construction")
 
  // CPM network delay (from WBS_Data Delay_Days_Based_on_Plan_Forecast_Finish)
  maxForecastDelayDaysOverall       Int @map("max_forecast_delay_days_overall")
  maxForecastDelayDaysEngineering   Int @map("max_forecast_delay_days_engineering")
  maxForecastDelayDaysProcurement   Int @map("max_forecast_delay_days_procurement")
  maxForecastDelayDaysConstruction  Int @map("max_forecast_delay_days_construction")
 
  
  floatTotalTaskCount       Int   @map("float_total_task_count")
  floatNegativeTaskCount    Int   @map("float_negative_task_count")    // float < 0
  floatZeroTaskCount        Int   @map("float_zero_task_count")        // float = 0 (on critical path)
  floatNearCriticalCount    Int   @map("float_near_critical_count")    // float 15 days
  floatPositiveTaskCount    Int   @map("float_positive_task_count")    // float > near_crit threshold
  floatAvgDays              Float @map("float_avg_days")
  floatMinDays              Int   @map("float_min_days")               // tightest float in project
  floatAtRiskPct            Float @map("float_at_risk_pct")            // % tasks with float d 0
 
  
  cadOverallPct       Float @map("cad_overall_pct")
  cadEngineeringPct   Float @map("cad_engineering_pct")
  cadProcurementPct   Float @map("cad_procurement_pct")
  cadConstructionPct  Float @map("cad_construction_pct")
 
  
  wrOverallPct       Float @map("wr_overall_pct")
  wrEngineeringPct   Float @map("wr_engineering_pct")
  wrProcurementPct   Float @map("wr_procurement_pct")
  wrConstructionPct  Float @map("wr_construction_pct")
 
  
  epOverallPct       Float @map("ep_overall_pct")
  epEngineeringPct   Float @map("ep_engineering_pct")
  epProcurementPct   Float @map("ep_procurement_pct")
  epConstructionPct  Float @map("ep_construction_pct")
 
  contributionOverallPct       Float @map("contribution_overall_pct")
  contributionEngineeringPct   Float @map("contribution_engineering_pct")
  contributionProcurementPct   Float @map("contribution_procurement_pct")
  contributionConstructionPct  Float @map("contribution_construction_pct")
 
  
  activitiesTotalCount      Int @map("activities_total_count")
  activitiesCompleteCount   Int @map("activities_complete_count")
  activitiesInProgressCount Int @map("activities_in_progress_count")
  activitiesOverdueCount    Int @map("activities_overdue_count")
  activitiesNotYetDueCount  Int @map("activities_not_yet_due_count")
 
  
  conLacWeekPct          Float @map("con_lac_week_pct")
  conLacMonthPct         Float @map("con_lac_month_pct")
  conLacCompletedRules   Int   @map("con_lac_completed_rules")
  conLacOverdueCount     Int   @map("con_lac_overdue_count")
  conLacAtRisk7DayCount  Int   @map("con_lac_at_risk_7day_count")
  conLacAtRisk30DayCount Int   @map("con_lac_at_risk_30day_count")
  conLacPendingCount     Int   @map("con_lac_pending_count")
 
  
  prcLacWeekPct          Float @map("prc_lac_week_pct")
  prcLacMonthPct         Float @map("prc_lac_month_pct")
  prcLacCompletedRules   Int   @map("prc_lac_completed_rules")
  prcLacOverdueCount     Int   @map("prc_lac_overdue_count")
  
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")
 
  
  @@index([projectKey])
  @@index([projectId])
  @@map("tbl_01_project_summary")
}
 
 model Tbl02ProjectActivity {
  id                       Int      @id @default(autoincrement())
  projectKey              Int      @map("project_key")
  activityCode            String   @map("activity_code")
  activityDescription     String   @map("activity_description")
  domain                  String?  @map("domain")
  domainCode              String?  @map("domain_code")
  customScurve            String?  @map("scurve")
  baselineStartDate       DateTime? @map("baseline_start_date")
  baselineFinishDate      DateTime? @map("baseline_finish_date")
  forecastStartDate       DateTime? @map("forecast_start_date")
  forecastFinishDate      DateTime? @map("forecast_finish_date")
  actualStartDate         DateTime? @map("actual_start_date")
  actualFinishDate        DateTime? @map("actual_finish_date")
  
  baselineDurationDays    Int?     @map("baseline_duration_days")
  forecastDurationDays    Int?     @map("forecast_duration_days")
  adjustedTotalDurationDays Int?   @map("adjusted_total_duration_days")
  slipDays                Int?     @map("slip_days")
  scheduleVarianceDays    Int?     @map("schedule_variance_days")
  
  activityStatus          String?  @map("activity_status")
  
  totalFloat              Float?   @map("total_float")
  isCriticalWrench        Boolean? @map("is_critical_wrench")
  projectMinFloatDays     Int?     @map("project_min_float_days")
  isControllingFloat      Boolean? @map("is_controlling_float")
  floatHealthStatus       String?  @map("float_health_status")
  floatHealthSortOrder    Int?     @map("float_health_sort_order")
  
  criticalActivityDensityPct Float? @map("critical_activity_density_pct")
  workfrontReadyPct        Float? @map("workfront_ready_pct")
  plannedProgressPct       Float? @map("planned_progress_pct")
  actualProgressPct        Float? @map("actual_progress_pct")
  forecastProgressPct      Float? @map("forecast_progress_pct")
  progressVariancePct      Float? @map("progress_variance_pct")
  
  plannedQuantity         Float?  @map("planned_quantity")
  earnedQuantity          Float?  @map("earned_quantity")
  executableProgressPct   Float?  @map("executable_progress_pct")
  
  contributionToProjectPct Float? @map("contribution_to_project_pct")
  activitySpi             Float?  @map("activity_spi")
  
  forecastDelayDays       Int?    @map("forecast_delay_days")
  
  cumulativePlannedProgress Float? @map("cumulative_planned_progress")
  cumulativeActualProgress  Float? @map("cumulative_actual_progress")
  cumulativeBacklogPct     Float? @map("cumulative_backlog_pct")
  domainSpi               Float?  @map("domain_spi")
  
  conTotalRules           Int?    @map("con_total_rules")
  conCompletedRules       Int?    @map("con_completed_rules")
  conOverdueRules         Int?    @map("con_overdue_rules")
  conAtRiskRules7Day      Int?    @map("con_at_risk_rules_7day")
  conAtRiskRules30Day     Int?    @map("con_at_risk_rules_30day")
  conPendingRules         Int?    @map("con_pending_rules")
  conLacWeekPct           Float?  @map("con_lac_week_pct")
  conLacMonthPct          Float?  @map("con_lac_month_pct")
  
  prcTotalRules           Int?    @map("prc_total_rules")
  prcCompletedRules       Int?    @map("prc_completed_rules")
  prcOverdueRules         Int?    @map("prc_overdue_rules")
  prcAtRiskRules7Day      Int?    @map("prc_at_risk_rules_7day")
  prcAtRiskRules30Day     Int?    @map("prc_at_risk_rules_30day")
  prcPendingRules         Int?    @map("prc_pending_rules")
  prcLacWeekPct           Float?  @map("prc_lac_week_pct")
  prcLacMonthPct          Float?  @map("prc_lac_month_pct")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([projectKey])
  @@index([activityCode])
  @@index([projectKey, domainCode])
  @@index([projectKey, totalFloat])
  @@index([projectKey, forecastDelayDays])

  @@map("tbl_project_activity")
}
